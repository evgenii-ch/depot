on: [push]
jobs:
  acceptance-testing:
    name: Acceptance and integration tests [core repo, old scripts repo]
    runs-on: "ubuntu-latest"
    timeout-minutes: 120
    services:
      hardhat-node:
        image: feofanov/hardhat-node
        ports:
          - 8545:8545
        env:
          INFURA_TOKEN: ${{ secrets.INFURA_TOKEN }}
    steps:
      - name: Check that the fork is ready
        shell: bash
        run: timeout 30 bash -c 'until printf "" 2>>/dev/null >>/dev/tcp/$0/$1; do sleep 1; done' 127.0.0.1 8545

      # Run core integration tests
      - uses: actions/checkout@v3
        with:
          repository: lidofinance/core
          ref: feat/integration

      - name: Enable corepack
        shell: bash
        run: corepack enable

      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: yarn

      - name: Install dependencies
        shell: bash
        run: yarn install

      - name: Set env
        shell: bash
        run: cp .env.example .env

      - name: Run integration tests
        shell: bash
        run: yarn test:integration:fork
        env:
          DEBUG: true

      # Run scripts repo acceptance tests
      - uses: actions/checkout@v3
        with:
          repository: lidofinance/scripts
          ref: feat/hardhat-fork

      - name: Install poetry
        shell: bash
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH
        env:
          POETRY_VERSION: "1.8.2"

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: poetry

      - name: Install poetry requirements
        shell: bash
        run: poetry install

      - name: Run acceptance tests
        shell: bash
        run: poetry run brownie test tests/acceptance/*
